<!DOCTYPE html>
<html class="light" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Transaksi Baru - Warung POS</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: { extend: { colors: { "primary": "#137fec", "background-dark": "#101922" } } }
        }
    </script>
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            if (savedTheme === 'dark') document.documentElement.classList.add('dark');
        })();
    </script>
</head>
<body class="bg-gray-50 dark:bg-background-dark text-gray-900 dark:text-white min-h-screen">

    <!-- Top Navigation Bar -->
<header class="sticky top-0 z-50 flex items-center justify-between whitespace-nowrap border-b border-solid border-[#dbe0e6] dark:border-gray-800 bg-white dark:bg-[#1a2632] px-10 py-3 shadow-sm">
<div class="flex items-center gap-4 text-[#111418] dark:text-white">
<div class="size-8 text-primary flex items-center justify-center bg-primary/10 rounded-lg">
<span class="material-symbols-outlined text-2xl">storefront</span>
</div>
<!-- <h2 class="text-[#111418] dark:text-white text-lg font-bold leading-tight tracking-[-0.015em]">Warung Berkah</h2> -->
<a href="{% url 'dashboard' %}" class="text-lg font-bold leading-tight tracking-[-0.015em]font-bold text-white-500 dark:text-white-400 hover:text-primary transition-colors">Toko Kelontong Eni</a>
</div>
<div class="flex flex-1 justify-end gap-8">
<div class="hidden md:flex items-center gap-9">
<a class="text-[#111418] dark:text-gray-200 text-sm font-medium leading-normal hover:text-primary transition-colors" href="{% url 'laporan' %}">Lihat Laporan</a>
</div>
<a href="{% url 'profile' request.session.ID %}">
<div class="flex items-center gap-3 pl-4 border-l border-[#dbe0e6] dark:border-gray-700">
<div class="text-right hidden sm:block">
<p class="text-sm font-bold leading-none">{{ request.session.nama }}</p>
<p class="text-xs text-gray-500 dark:text-gray-400 mt-1">{{ request.session.hak }}</p>
</div>
<div class="user-avatar-target bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10 border-2 border-primary/20" data-alt="Portrait of Budi Santoso user avatar" style="background-image: url('{{ request.session.foto|default:'/static/img/default-avatar.png' }}');"></div>
</div>
</a>
</div>
</header>

    <div class="max-w-5xl mx-auto p-6">
        <form action="{% url 'tambah_transaksi' %}" method="POST" id="formTransaksi">
            {% csrf_token %}
            
            <h1 class="text-2xl font-bold mb-6">Transaksi Baru </h1>

            <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm mb-6 grid grid-cols-2 gap-4 border dark:border-gray-700">
                <div>
                    <label class="block text-sm font-medium mb-1">Nama Pembeli</label>
                    <input name="nama_pembeli" type="text" value="Umum" class="w-full rounded-lg border-gray-300 dark:bg-gray-700 dark:border-gray-600">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Tanggal</label>
                    <input name="tanggal_transaksi" type="date" value="{% now 'Y-m-d' %}" class="w-full rounded-lg border-gray-300 dark:bg-gray-700 dark:border-gray-600">
                </div>
            </div>

            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border dark:border-gray-700 overflow-visible">
                <table class="w-full">
                    <thead class="bg-gray-50 dark:bg-gray-700 text-xs uppercase font-bold">
                        <tr>
                            <th class="px-6 py-3 text-left">Barang</th>
                            <th class="px-6 py-3 text-left">Harga</th>
                            <th class="px-6 py-3 text-center">Qty</th>
                            <th class="px-6 py-3 text-left">Subtotal</th>
                            <th class="px-6 py-3 text-center">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="tbodyKeranjang" class="divide-y dark:divide-gray-700"></tbody>
                    <tfoot class="bg-blue-50/50 dark:bg-gray-900/50 relative">
                        <tr>
                            <td class="px-6 py-4" colspan="2">
                                <div class="relative overflow-visible">
                                    <input type="text" 
                                        id="searchBarang" 
                                        oninput="cariBarang(this)" 
                                        placeholder="Cari nama barang..." 
                                        autocomplete="off" 
                                        class="w-full rounded-lg border-gray-300 dark:bg-gray-700 dark:border-gray-600 focus:ring-primary">
                                    
                                    <div id="hasilPencarian" 
                                        class="absolute left-0 right-0 bottom-full mb-2 bg-white dark:bg-gray-800 border dark:border-gray-600 rounded-xl shadow-2xl hidden overflow-hidden z-[200] max-h-60 overflow-y-auto border-2 border-primary/20">
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <input type="number" id="inputQty" value="1" min="1" class="w-20 mx-auto block rounded-lg border-gray-300 dark:bg-gray-700 dark:border-gray-600 text-center focus:ring-primary font-bold">
                            </td>
                            <td colspan="2" class="px-6 py-4">
                                <button type="button" onclick="tambahKeKeranjang()" id="btnTambah" class="w-full bg-primary text-white py-2.5 rounded-lg font-bold hover:bg-blue-600 transition-all shadow-md active:scale-95 flex justify-center items-center gap-2">
                                    <span class="material-symbols-outlined text-sm">add_shopping_cart</span> Tambah
                                </button>
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <div class="mt-6 flex justify-between items-center bg-white dark:bg-gray-800 p-6 rounded-xl border dark:border-gray-700 shadow-sm">
                <div class="text-lg">Total: <span id="totalBayarText" class="font-black text-3xl text-primary">Rp 0</span></div>
                <button type="submit" class="bg-green-600 text-white px-10 py-3 rounded-xl font-bold hover:bg-green-700 shadow-lg transition-transform active:scale-95">Simpan Transaksi</button>
            </div>
        </form>
    </div>

    <script>
        const dataBarang = [
            {% for b in daftar_barang %}
                {   
                    id: "{{ b.id }}",
                    nama: "{{ b.nama }}",
                    harga: {{ b.hargajual|default:0|floatformat:'0' }},
                    stok: {{ b.stok|default:0|floatformat:'0' }}
                }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];

        let keranjang = [];
        let barangTerpilih = null;

        function cariBarang(input) {
            const keyword = input.value.toLowerCase();
            const hasilDiv = document.getElementById('hasilPencarian');
            hasilDiv.innerHTML = '';

            if (keyword.length < 1) {
                hasilDiv.classList.add('hidden');
                return;
            }

            const matches = dataBarang.filter(b => b.nama.toLowerCase().includes(keyword));

            if (matches.length > 0) {
                matches.forEach(b => {
                    const item = document.createElement('div');
                    item.className = "px-4 py-3 hover:bg-primary/10 dark:hover:bg-primary/20 cursor-pointer border-b dark:border-gray-700 last:border-none text-[#111418] dark:text-white transition-all";
                    item.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <div class="font-bold text-sm">${b.nama}</div>
                                <div class="text-[10px] uppercase tracking-wider text-gray-400 font-semibold">Stok: ${b.stok}</div>
                            </div>
                            <div class="text-primary font-black text-sm px-3 py-1 bg-primary/5 rounded-full">Rp ${parseInt(b.harga).toLocaleString('id-ID')}</div>
                        </div>
                    `;
                    item.onclick = function() {
                        document.getElementById('searchBarang').value = b.nama;
                        barangTerpilih = b; 
                        hasilDiv.classList.add('hidden');
                        document.getElementById('inputQty').focus();
                    };
                    hasilDiv.appendChild(item);
                });
                hasilDiv.classList.remove('hidden');
            } else {
                hasilDiv.classList.add('hidden');
            }
        }

        function tambahKeKeranjang() {
            const inputQty = document.getElementById('inputQty');
            const qty = parseInt(inputQty.value);

            if (!barangTerpilih) {
                alert("Klik dulu barang dari daftar pencarian!");
                return;
            }

            if (qty > barangTerpilih.stok) {
                alert("Stok tidak mencukupi!");
                return;
            }

            const existingIndex = keranjang.findIndex(item => item.id === barangTerpilih.id);
            if (existingIndex !== -1) {
                keranjang[existingIndex].qty += qty;
            } else {
                keranjang.push({
                    id: barangTerpilih.id,
                    nama: barangTerpilih.nama,
                    harga: parseInt(barangTerpilih.harga),
                    qty: qty
                });
            }

            document.getElementById('searchBarang').value = '';
            inputQty.value = 1;
            barangTerpilih = null;
            renderTabel();
        }

        function renderTabel() {
            const tbody = document.getElementById('tbodyKeranjang');
            const totalText = document.getElementById('totalBayarText');
            let totalHarga = 0;
            
            tbody.innerHTML = '';

            keranjang.forEach((item, index) => {
                const subtotal = item.harga * item.qty;
                totalHarga += subtotal;

                tbody.innerHTML += `
                    <tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors">
                        <td class="px-6 py-4">
                            <div class="font-semibold dark:text-white">${item.nama}</div>
                            <input type="hidden" name="item_barang[]" value="${item.id}">
                            <input type="hidden" name="item_harga[]" value="${item.harga}">
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-500">Rp ${item.harga.toLocaleString('id-ID')}</td>
                        <td class="px-6 py-4 text-center">
                            <input type="number" name="item_qty[]" value="${item.qty}" 
                                onchange="updateQty(${index}, this.value)"
                                class="w-16 border-none bg-gray-100 dark:bg-gray-700 rounded-lg text-center font-bold">
                        </td>
                        <td class="px-6 py-4 font-bold text-primary">Rp ${subtotal.toLocaleString('id-ID')}</td>
                        <td class="px-6 py-4 text-center">
                            <button type="button" onclick="hapusBarang(${index})" class="p-2 hover:bg-red-50 dark:hover:bg-red-900/20 text-red-500 rounded-full transition-all">
                                <span class="material-symbols-outlined">delete</span>
                            </button>
                        </td>
                    </tr>
                `;
            });

            totalText.innerText = `Rp ${totalHarga.toLocaleString('id-ID')}`;
        }

        function hapusBarang(index) {
            keranjang.splice(index, 1);
            renderTabel();
        }

        function updateQty(index, val) {
            if (val < 1) return;
            keranjang[index].qty = parseInt(val);
            renderTabel();
        }

        document.addEventListener('click', function(e) {
            const hasilDiv = document.getElementById('hasilPencarian');
            if (!e.target.closest('#searchBarang')) {
                hasilDiv.classList.add('hidden');
            }
        });
    </script>
</body>
</html>